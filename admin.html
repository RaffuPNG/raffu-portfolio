<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard — Slots</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0f; --panel:#131318; --ink:#eaeaf1; --muted:#9aa0a6; --accent:#ff6a00; --ok:#19c37d; --err:#ff4d4d;
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,#0b0b0f 0%, #0c0c12 100%); color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px; margin:0 auto; padding:20px}
  h1{margin:8px 0 14px}
  .muted{color:var(--muted)}
  .panel{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); padding:16px; margin:12px 0}
  .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .btn{border:none; background:#2a2b32; color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700}
  .btn:hover{background:#343541}
  .btn.ok{background:var(--ok); color:#04130b}
  .btn.err{background:var(--err); color:#160606}
  .slot{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); cursor:pointer; font-weight:700}
  .slot.free{background:var(--ok); color:#04130b}
  .slot.taken{background:#20212a; color:#eaeaf1}
  .orders{display:grid; gap:10px}
  .card{padding:12px; border-radius:12px; background:#0f1016; border:1px solid rgba(255,255,255,.06)}
  .card h4{margin:0 0 6px}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800}
  .pill.pending{background:#3a2b12; color:#ffbf66}
  .pill.captured{background:#123a2a; color:#74ffc9}
  .pill.voided{background:#3a1212; color:#ffa3a3}
  .small{font-size:13px}
  .right{margin-left:auto}
  .headline{display:flex; align-items:center; gap:8px}
  .footer-note{font-size:12px; color:var(--muted); margin-top:10px}
  .errbox{background:#2a1414; border:1px solid #542222; color:#ffb3b3; padding:8px 10px; border-radius:10px; display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="headline">
    <h1>Admin Dashboard — Slots</h1>
    <span class="right muted small">Logged in as <strong id="whoami">Not logged in</strong></span>
  </div>
  <div class="row" style="margin-bottom:10px">
    <button id="loginBtn" class="btn">Log in</button>
    <button id="logoutBtn" class="btn">Log out</button>
    <button id="refreshBtn" class="btn">Refresh</button>
    <span class="muted small">If Brave/Ad-blocker is on, disable shields for this site.</span>
  </div>

  <div class="panel">
    <div class="headline" style="margin-bottom:8px">
      <h2 style="margin:0">Commission Slots</h2>
      <span id="slotsSummary" class="muted small right">Loading…</span>
    </div>
    <div id="slotsRow" class="row"></div>
    <div id="slotsStatus" class="footer-note">Loading slots…</div>
  </div>

  <div class="panel">
    <div class="headline" style="margin-bottom:8px">
      <h2 style="margin:0">Pending Authorizations</h2>
      <span id="ordersSummary" class="muted small right">Loading…</span>
    </div>
    <div id="ordersList" class="orders"></div>
    <div id="ordersStatus" class="footer-note">Loading…</div>
  </div>

  <div id="errBox" class="errbox"></div>
</div>

<!-- Netlify Identity -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
/* ================== Helpers ================== */
const $ = (s) => document.querySelector(s);
const fmt = (n) => new Intl.NumberFormat('en-US', { style:'currency', currency:'EUR' }).format(n);
const time = (ms) => new Date(ms).toLocaleString([], { hour:'2-digit', minute:'2-digit', year:'numeric', month:'short', day:'2-digit' });

function showErr(msg){
  const box = $('#errBox');
  box.textContent = msg || '';
  box.style.display = msg ? 'block' : 'none';
}

/* -------- Identity -------- */
netlifyIdentity.init();
function updateLoginUI(){
  const user = netlifyIdentity.currentUser();
  $('#whoami').textContent = user?.email || 'Not logged in';
}

// Force-refresh JWT and set nf_jwt cookie (works even if headers are stripped)
async function getFreshJwtAndSetCookie(){
  const user = netlifyIdentity.currentUser();
  if(!user) return null;
  try{
    const jwt = await user.jwt(true); // force refresh
    // Set nf_jwt cookie for 15 minutes
    document.cookie = `nf_jwt=${jwt}; Path=/; Max-Age=900; Secure; SameSite=Lax`;
    return jwt;
  }catch(e){
    console.warn('jwt error', e);
    return null;
  }
}

async function authHeader(){
  const jwt = await getFreshJwtAndSetCookie();
  if(!jwt) return null;
  return { Authorization: `Bearer ${jwt}` };
}

/* -------- API wrappers -------- */
async function api(path, {method='GET', body=null, auth=false}={}){
  showErr('');
  const headers = { 'Content-Type':'application/json' };
  if(auth){
    const h = await authHeader();
    if(!h) throw new Error('Auth required (not logged in)');
    Object.assign(headers, h);
  }
  const r = await fetch(path, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null,
    credentials: 'include' // send nf_jwt cookie too
  });
  let j; try { j = await r.json(); } catch { j = {}; }
  if(!r.ok){
    const msg = j?.error || j?.message || `HTTP ${r.status}`;
    throw new Error(msg);
  }
  return j;
}

/* ================== Slots ================== */
async function loadSlots(){
  try{
    $('#slotsStatus').textContent = 'Loading slots…';
    const data = await api('/.netlify/functions/slots');
    const slots = Array.isArray(data.slots) ? data.slots : [true,true,true,true];
    const row = $('#slotsRow'); row.innerHTML = '';
    let freeCount = 0;

    slots.forEach((isFree, i)=>{
      if(isFree) freeCount++;
      const b = document.createElement('button');
      b.className = 'slot ' + (isFree ? 'free' : 'taken');
      b.textContent = (isFree ? 'Free' : 'Taken') + ' — Slot ' + (i+1);
      b.onclick = async ()=>{
        try{
          const reserve = isFree ? true : false; // clicking toggles
          await api('/.netlify/functions/slots', { method:'POST', body:{ slot:i, reserve }});
          await loadSlots();
        }catch(e){ showErr(e.message); }
      };
      row.appendChild(b);
    });

    $('#slotsSummary').textContent = `${freeCount}/${slots.length} free`;
    $('#slotsStatus').textContent = 'Click a slot to toggle Free/Taken.';
  }catch(e){
    $('#slotsStatus').textContent = 'Error loading slots.';
    showErr(e.message);
  }
}

/* ================== Orders ================== */
function orderCard(o){
  const div = document.createElement('div');
  div.className = 'card';

  const statusClass = o.status === 'authorized' ? 'pending' : (o.status === 'captured' ? 'captured' : 'voided');
  const head = document.createElement('div');
  head.className = 'row';
  head.innerHTML = `
    <h4 style="margin:0">Order <code>${o.id}</code></h4>
    <span class="pill ${statusClass}">${o.status}</span>
    <span class="right small muted">${time(o.createdAt)}</span>
  `;
  div.appendChild(head);

  const body = document.createElement('div');
  body.className = 'small';
  body.innerHTML = `
    <div><strong>Email:</strong> ${o.email || '(none)'} &nbsp; <strong>Payer:</strong> ${o.payerEmail || '(unknown)'}</div>
    <div><strong>Package:</strong> ${o.package || ''} — ${o.priceLabel || ''} &nbsp; <strong>Extras:</strong> ${o.extras || 0} &nbsp; <strong>Total:</strong> ${fmt(o.totalEUR || 0)}</div>
    <div><strong>Slot:</strong> ${typeof o.slotIndex==='number' ? (o.slotIndex+1) : '?'}</div>
    <div style="margin-top:6px; white-space:pre-wrap" class="muted">${o.description || ''}</div>
  `;
  div.appendChild(body);

  if(o.status === 'authorized'){
    const actions = document.createElement('div');
    actions.className = 'row';
    const accept = document.createElement('button');
    accept.className = 'btn ok';
    accept.textContent = 'Accept (Capture)';
    accept.onclick = async ()=>{
      accept.disabled = true;
      try{
        await api('/.netlify/functions/pp-capture', { method:'POST', body:{ id:o.id }, auth:true });
        await refreshAll();
      }catch(e){ showErr(e.message); accept.disabled = false; }
    };
    const decline = document.createElement('button');
    decline.className = 'btn err';
    decline.textContent = 'Decline (Void & Free slot)';
    decline.onclick = async ()=>{
      decline.disabled = true;
      try{
        await api('/.netlify/functions/pp-void', { method:'POST', body:{ id:o.id }, auth:true });
        await refreshAll();
      }catch(e){ showErr(e.message); decline.disabled = false; }
    };
    actions.appendChild(accept);
    actions.appendChild(decline);
    div.appendChild(actions);
  }

  return div;
}

async function loadOrders(){
  try{
    $('#ordersStatus').textContent = 'Loading…';
    const data = await api('/.netlify/functions/orders', { auth:true });
    const orders = Array.isArray(data.orders) ? data.orders : [];
    const pending = orders.filter(o => o.status === 'authorized');
    const list = $('#ordersList'); list.innerHTML = '';
    if(!pending.length){
      $('#ordersStatus').textContent = 'No orders yet.';
    }else{
      $('#ordersStatus').textContent = '';
    }
    pending.forEach(o => list.appendChild(orderCard(o)));
    $('#ordersSummary').textContent = `${pending.length} pending`;
  }catch(e){
    $('#ordersStatus').textContent = (e.message.toLowerCase().includes('auth')) ? 'Auth required. Please Log in.' : 'Error loading orders.';
    showErr(e.message);
    $('#ordersSummary').textContent = '—';
  }
}

/* ================== Boot & Events ================== */
async function refreshAll(){
  updateLoginUI();
  await loadSlots();
  await loadOrders();
}

document.addEventListener('DOMContentLoaded', ()=>{
  updateLoginUI();
  loadSlots();
  loadOrders();

  $('#loginBtn').onclick  = () => netlifyIdentity.open('login');
  $('#logoutBtn').onclick = () => netlifyIdentity.logout();
  $('#refreshBtn').onclick = () => refreshAll();
});

// When login happens, refresh JWT + cookie then reload lists
netlifyIdentity.on('login',  async () => { updateLoginUI(); await getFreshJwtAndSetCookie(); refreshAll(); });
netlifyIdentity.on('init',   async () => { updateLoginUI(); await getFreshJwtAndSetCookie(); });
netlifyIdentity.on('logout', () => { updateLoginUI(); loadOrders(); });
</script>
</body>
</html>
