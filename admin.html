<script>
const ADMIN_FN = '/.netlify/functions/admin-slots';

const slotGrid      = document.getElementById('slotGrid');
const app           = document.getElementById('app');
const guard         = document.getElementById('guard');
const loginBtn      = document.getElementById('loginBtn');
const logoutBtn     = document.getElementById('logoutBtn');
const refreshBtn    = document.getElementById('refreshBtn');
const adminEmailEl  = document.getElementById('adminEmail');

function showApp(show){
  app.classList.toggle('hidden', !show);
  guard.classList.toggle('hidden', show);
  loginBtn.classList.toggle('hidden', show);
  logoutBtn.classList.toggle('hidden', !show);
}

function setGuard(msg){ guard.textContent = msg; }

async function currentJWT(){
  const user = netlifyIdentity.currentUser();
  if(!user) return null;
  try { return await user.jwt(); } catch { return null; }
}

async function api(path, opts={}){
  const token = await currentJWT();
  const headers = { 'Content-Type':'application/json', ...(opts.headers||{}) };
  if(token) headers.Authorization = 'Bearer ' + token;
  const res = await fetch(ADMIN_FN + path, { ...opts, headers, cache:'no-store' });
  if(!res.ok){
    const text = await res.text();
    throw new Error(text || ('HTTP '+res.status));
  }
  return res.json();
}

async function loadSlots(){
  const data = await api('?v=' + Date.now());
  renderSlots(data.slots || []);
}

function renderSlots(slots){
  slotGrid.innerHTML = '';
  slots.forEach((isFree, i)=>{
    const card = document.createElement('div');
    card.className = 'slot';
    card.innerHTML = `
      <h3>Slot ${i+1}</h3>
      <div class="row">
        <div class="muted">Status: ${isFree ? 'FREE' : 'TAKEN'}</div>
        <div>
          <button class="ok"  data-act="free" data-i="${i}">Free</button>
          <button class="bad" data-act="take" data-i="${i}">Take</button>
        </div>
      </div>`;
    slotGrid.appendChild(card);
  });
}

slotGrid.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-act]');
  if(!btn) return;
  const i = parseInt(btn.dataset.i,10);
  const act = btn.dataset.act; // free | take
  try{
    await api('', { method:'POST', body: JSON.stringify({ slot:i, free:(act==='free') }) });
    await loadSlots();
  }catch(err){
    alert('Save error: ' + err.message);
  }
});

refreshBtn.addEventListener('click', loadSlots);
loginBtn.addEventListener('click', ()=> netlifyIdentity.open('login'));
logoutBtn.addEventListener('click', ()=> netlifyIdentity.logout());

// Robust login detection
async function onReady(){
  const user = netlifyIdentity.currentUser();
  if(user){
    adminEmailEl.textContent = 'Signed in as: ' + (user.email || '');
    showApp(true);
    try { await loadSlots(); }
    catch(err){ alert('Load error: ' + err.message); }
  }else{
    showApp(false);
    setGuard('Please log in to manage slots.');
  }
}

netlifyIdentity.on('init', onReady);
netlifyIdentity.on('login', async (user)=>{
  adminEmailEl.textContent = 'Signed in as: ' + (user?.email || '');
  showApp(true);
  netlifyIdentity.close();
  try { await loadSlots(); } catch(err){ alert('Load error: ' + err.message); }
});
netlifyIdentity.on('logout', ()=>{
  adminEmailEl.textContent = '';
  showApp(false);
  setGuard('Please log in to manage slots.');
});

netlifyIdentity.init();

// If the init event fired before listeners attached, force a check:
setTimeout(onReady, 200);
</script>
