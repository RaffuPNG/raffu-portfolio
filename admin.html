<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Dashboard — Slots & Orders</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
  :root{ --bg:#0b0b0f; --panel:#131318; --ink:#eaeaf1; --muted:#9aa0a6; --accent:#ff6a00; --radius:14px; }
  body{margin:0; background:#0b0b0f; color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px; margin:0 auto; padding:20px}
  .panel{background:linear-gradient(180deg,#141419,#0f0f14); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); padding:16px; margin:12px 0}
  h1{margin:8px 0 4px} h2{margin:0 0 10px}
  .btn{border:none; padding:8px 12px; border-radius:10px; cursor:pointer}
  .btn.primary{background:var(--accent); color:#0b0b0f; font-weight:800}
  .muted{color:var(--muted)}
  .slot{display:inline-block; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.1); margin-right:8px; margin-bottom:8px; cursor:pointer}
  .slot.free{background:#ff6a00; color:#0b0b0f} .slot.taken{background:#0b0b0f; color:#eaeaf1}
</style>
</head>
<body>
<div class="wrap">
  <h1>Admin Dashboard — Slots</h1>
  <div class="muted" id="authState">Please log in to manage.</div>
  <div style="margin:8px 0">
    <button class="btn" id="loginBtn">Log in</button>
    <button class="btn" id="logoutBtn" style="display:none">Log out</button>
  </div>

  <section class="panel">
    <h2>Commission Slots</h2>
    <div id="slotsWrap" class="muted">Loading…</div>
  </section>

  <section class="panel">
    <h2>Pending Authorizations</h2>
    <div id="ordersWrap" class="muted">Loading…</div>
  </section>
</div>

<script>
const SLOT_API='/.netlify/functions/slots';
const ORDERS_API='/.netlify/functions/orders';
const CAPTURE_API='/.netlify/functions/pp-capture';
const VOID_API='/.netlify/functions/pp-void';

const authState=document.getElementById('authState');
const loginBtn=document.getElementById('loginBtn'), logoutBtn=document.getElementById('logoutBtn');

loginBtn.onclick=()=>netlifyIdentity.open('login');
logoutBtn.onclick=()=>netlifyIdentity.logout();

netlifyIdentity.on('init', user=>{ updateAuth(user); if(user){ loadSlots(); loadOrders(); } });
netlifyIdentity.on('login', user=>{ updateAuth(user); loadSlots(); loadOrders(); });
netlifyIdentity.on('logout', ()=>{ updateAuth(null); document.getElementById('slotsWrap').textContent=''; document.getElementById('ordersWrap').textContent=''; });

function updateAuth(user){
  if(user){ authState.textContent='Logged in as '+(user.email||''); loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; }
  else{ authState.textContent='Please log in to manage.'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; }
}

async function authFetch(url,opts={}){
  const u = netlifyIdentity.currentUser();
  const t = u ? await u.jwt() : null;
  opts.headers = Object.assign({}, opts.headers||{}, t?{Authorization:`Bearer ${t}`}:{});
  return fetch(url, opts);
}

/* SLOTS */
async function loadSlots(){
  const c=document.getElementById('slotsWrap'); c.textContent='Loading…';
  try{
    const r=await fetch(SLOT_API); const d=await r.json(); const slots=Array.isArray(d.slots)?d.slots:[true,true,true,true];
    c.innerHTML='';
    slots.forEach((s,i)=>{
      const el=document.createElement('button');
      el.className='slot '+(s?'free':'taken');
      el.textContent=(s?'Free':'Taken')+' — Slot '+(i+1);
      el.onclick=async()=>{
        el.disabled=true;
        await authFetch(SLOT_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({slot:i,reserve:!s})});
        loadSlots();
      };
      c.appendChild(el);
    });
  }catch(_){ c.textContent='Error loading slots.'; }
}

/* ORDERS */
async function loadOrders(){
  const c=document.getElementById('ordersWrap'); c.textContent='Loading…';
  try{
    const r=await authFetch(ORDERS_API);
    if(!r.ok){ c.textContent='Auth required or error.'; return; }
    const {orders=[]}=await r.json();
    if(!orders.length){ c.textContent='No orders yet.'; return; }
    c.innerHTML='';
    orders.forEach(o=>{
      const row=document.createElement('div');
      row.style.cssText='display:flex; gap:8px; align-items:center; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:8px; margin:6px 0;';
      row.innerHTML=`
        <div style="flex:1">
          <strong>${o.email}</strong> — ${o.package} (${o.priceLabel})
          <div class="muted">Total: €${o.totalEUR} • Slot ${Number(o.slotIndex)+1} • Status: <b>${o.status}</b></div>
          <div class="muted" style="white-space:pre-wrap; margin-top:4px">${o.description||''}</div>
        </div>
        <div style="display:flex; gap:6px">
          <button class="btn" data-act="void" data-id="${o.id}" ${o.status!=='authorized'?'disabled':''}>Decline (void)</button>
          <button class="btn primary" data-act="capture" data-id="${o.id}" ${o.status!=='authorized'?'disabled':''}>Accept (capture)</button>
        </div>`;
      c.appendChild(row);
    });
  }catch(_){ c.textContent='Error loading orders.'; }
}

document.addEventListener('click', async (e)=>{
  const btn=e.target.closest('button[data-act]'); if(!btn) return;
  btn.disabled=true; const id=btn.dataset.id; const act=btn.dataset.act;
  try{
    if(act==='capture'){
      const r=await authFetch(CAPTURE_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
      if(!r.ok) throw new Error('capture failed');
    }else{
      const r=await authFetch(VOID_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
      if(!r.ok) throw new Error('void failed');
    }
  }catch(err){ alert('Error: '+err.message); }
  loadOrders(); loadSlots();
});

/* Start Identity */
netlifyIdentity.init();
</script>
</body>
</html>
