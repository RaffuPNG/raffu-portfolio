<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Commission Slots</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script defer src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<style>
  :root{ --bg:#0b0b0f; --panel:#131318; --ink:#eaeaf1; --muted:#9aa0a6; --accent:#ff6a00; --ok:#18c964; --bad:#ff4d4d; }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui; background:linear-gradient(180deg,#0b0b0f,#0f0f15); color:var(--ink)}
  .wrap{max-width:900px; margin:0 auto; padding:20px}
  h1{margin:10px 0 16px}
  .panel{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:16px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .slot{border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px}
  .slot h3{margin:0 0 6px}
  .muted{color:var(--muted)}
  .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
  button{border:none; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer}
  .btn{background:#2a2b32; color:#fff}
  .ok{background:var(--ok); color:#0b0b0f}
  .bad{background:var(--bad); color:#0b0b0f}
  .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px}
  .notice{background:#111218; border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:10px;}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1>Admin Dashboard — Slots</h1>
    <div>
      <button id="loginBtn" class="btn">Log in</button>
      <button id="logoutBtn" class="btn hidden">Log out</button>
    </div>
  </div>

  <div id="guard" class="notice">Loading…</div>

  <div id="app" class="panel hidden">
    <div class="row" style="margin-bottom:10px">
      <div class="muted" id="adminEmail"></div>
      <div style="display:flex;gap:8px">
        <button id="refreshBtn" class="btn">Refresh</button>
        <button id="forceBtn" class="btn">Force render</button>
      </div>
    </div>
    <div class="grid" id="slotGrid"></div>
  </div>
</div>

<script>
/* =========== ADMIN UI (robust) =========== */
const ADMIN_FN = '/.netlify/functions/admin-slots';

const el = (id) => document.getElementById(id);
const slotGrid = el('slotGrid');
const app = el('app');
const guard = el('guard');
const loginBtn = el('loginBtn');
const logoutBtn = el('logoutBtn');
const refreshBtn = el('refreshBtn');
const adminEmailEl = el('adminEmail');

function showApp(show){
  app.classList.toggle('hidden', !show);
  guard.classList.toggle('hidden', show);
  loginBtn.classList.toggle('hidden', show);
  logoutBtn.classList.toggle('hidden', !show);
}
function setGuard(msg){ guard.textContent = msg; }

/* ---- helpers ---- */
async function currentJWT(){
  const user = netlifyIdentity.currentUser();
  if(!user) return null;
  try { return await user.jwt(); } catch { return null; }
}
async function api(path, opts={}){
  const token = await currentJWT();
  if(!token) throw new Error('No Identity session yet');
  const headers = { 'Content-Type':'application/json', ...(opts.headers||{}), Authorization: 'Bearer ' + token };
  const res = await fetch(ADMIN_FN + path, { ...opts, headers, cache:'no-store' });
  if(!res.ok){
    const txt = await res.text();
    throw new Error(txt || ('HTTP '+res.status));
  }
  return res.json();
}

function renderSlots(slots){
  slotGrid.innerHTML = '';
  slots.forEach((isFree, i)=>{
    const card = document.createElement('div');
    card.className = 'slot';
    card.innerHTML = `
      <h3>Slot ${i+1}</h3>
      <div class="row">
        <div class="muted">Status: ${isFree ? 'FREE' : 'TAKEN'}</div>
        <div>
          <button class="ok"  data-act="free" data-i="${i}">Free</button>
          <button class="bad" data-act="take" data-i="${i}">Take</button>
        </div>
      </div>`;
    slotGrid.appendChild(card);
  });
}
async function loadSlots(){
  const data = await api('?v=' + Date.now());
  renderSlots(data.slots || []);
}

/* ---- events ---- */
slotGrid.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-act]');
  if(!btn) return;
  const i = parseInt(btn.dataset.i,10);
  const free = btn.dataset.act === 'free';
  try{
    await api('', { method:'POST', body: JSON.stringify({ slot:i, free }) });
    await loadSlots();
  }catch(err){ alert('Save error: ' + err.message); }
});
refreshBtn.addEventListener('click', loadSlots);
loginBtn.addEventListener('click', ()=> netlifyIdentity.open('login'));
logoutBtn.addEventListener('click', ()=> netlifyIdentity.logout());

/* ---- super-robust session detection ----
   1) react to identity events
   2) poll for up to 30s (covers browsers where currentUser appears late)
-------------------------------------------------- */
async function tryRender(){
  const u = netlifyIdentity.currentUser();
  if(!u){ setGuard('Please log in to manage slots.'); showApp(false); return; }
  adminEmailEl.textContent = 'Signed in as: ' + (u.email || '');
  showApp(true);
  await loadSlots();
}

function startPoll(){
  let tries = 0;
  const timer = setInterval(async ()=>{
    tries++;
    const u = netlifyIdentity.currentUser && netlifyIdentity.currentUser();
    if (u){
      clearInterval(timer);
      try { await tryRender(); } catch (e){ alert('Load error: ' + e.message); }
    } else if (tries > 60){ // ~30s
      clearInterval(timer);
      setGuard('Please log in to manage slots.');
      showApp(false);
    }
  }, 500);
}

/* attach listeners BEFORE init */
netlifyIdentity.on('init', async () => {
  const u = netlifyIdentity.currentUser && netlifyIdentity.currentUser();
  if (u) { try { await tryRender(); } catch(e){ alert('Load error: ' + e.message); } }
  else { setGuard('Loading…'); startPoll(); }
});
netlifyIdentity.on('login', async (user)=>{
  netlifyIdentity.close();
  adminEmailEl.textContent = 'Signed in as: ' + (user?.email || '');
  showApp(true);
  try { await loadSlots(); } catch(e){ alert('Load error: ' + e.message); }
});
netlifyIdentity.on('logout', ()=>{
  adminEmailEl.textContent = '';
  showApp(false);
  setGuard('Please log in to manage slots.');
});

netlifyIdentity.init();

/* fallback if the init event fires too early */
setTimeout(()=> {
  const u = netlifyIdentity.currentUser && netlifyIdentity.currentUser();
  if (!u) startPoll();
}, 300);
</script>
</body>
</html>
